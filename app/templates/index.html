<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π</h1>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –∏–¥–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</p>
        </header>

        <div class="main-content">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="control-panel">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="card stats-card">
                    <h2><i class="fas fa-chart-pie"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">{{ subjects|length }}</div>
                            <div class="stat-label">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ subjects|sum(attribute='total_hours') }}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ subjects|sum(attribute='remaining_hours') }}</div>
                            <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å —á–∞—Å–æ–≤</div>
                        </div>
                    </div>
                </div>

                <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
                <div class="card">
                    <h2><i class="fas fa-book"></i> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
                    <form method="post" action="/add-subject" class="form-grid">
                        <div class="input-group">
                            <label for="teacher"><i class="fas fa-user-tie"></i> –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</label>
                            <input type="text" id="teacher" name="teacher" placeholder="–§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è" required>
                        </div>

                        <div class="input-group">
                            <label for="subject_name"><i class="fas fa-graduation-cap"></i> –ü—Ä–µ–¥–º–µ—Ç:</label>
                            <input type="text" id="subject_name" name="subject_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" required>
                        </div>

                        <div class="input-group">
                            <label for="hours"><i class="fas fa-clock"></i> –ß–∞—Å—ã (–∫—Ä–∞—Ç–Ω–æ 2):</label>
                            <input type="number" id="hours" name="hours" min="2" value="4" step="2" required>
                        </div>

                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç
                        </button>
                    </form>
                </div>

                <!-- –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                <div class="card">
                    <h2><i class="fas fa-ban"></i> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</h2>
                    <form method="post" action="/add-negative-filter" class="form-grid">
                        <div class="input-group">
                            <label for="filter_teacher"><i class="fas fa-user-tie"></i> –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</label>
                            <select id="filter_teacher" name="teacher" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.teacher }}">{{ subject.teacher }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="input-group">
                            <label><i class="fas fa-calendar-times"></i> –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –¥–Ω–∏:</label>
                            <div class="checkbox-grid">
                                {% for day in week_days[:5] %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="restricted_days" value="{{ loop.index0 }}">
                                    <span class="day-badge">{{ day[:2] }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="input-group">
                            <label><i class="fas fa-clock"></i> –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã:</label>
                            <div class="checkbox-grid">
                                {% for time_slot in time_slots %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="restricted_slots" value="{{ loop.index0 }}">
                                    <span class="slot-badge">{{ loop.index0 + 1 }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <button type="submit" class="btn-secondary">
                            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                        </button>
                    </form>

                    <div class="filters-list">
                        <h3><i class="fas fa-list"></i> –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</h3>
                        {% for teacher, filter in negative_filters.items() %}
                        <div class="filter-item">
                            <div class="filter-info">
                                <strong>{{ teacher }}</strong>
                                <div class="filter-details">
                                    {% if filter.restricted_days %}
                                    <span class="filter-tag">
                                        <i class="fas fa-calendar"></i>
                                        –î–Ω–∏: {{ filter.restricted_days | join(', ') }}
                                    </span>
                                    {% endif %}
                                    {% if filter.restricted_slots %}
                                    <span class="filter-tag">
                                        <i class="fas fa-clock"></i>
                                        –ü–∞—Ä—ã: {{ filter.restricted_slots | join(', ') }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <form method="post" action="/remove-negative-filter/{{ teacher }}">
                                <button type="submit" class="btn-small btn-danger"
                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è {{ teacher }}?')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                        {% else %}
                        <p class="empty-state">–ù–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                <div class="card">
                    <h2><i class="fas fa-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                    <div class="buttons-grid">
                        <form method="post" action="/generate-schedule">
                            <button type="submit" class="btn-success">
                                <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                            </button>
                        </form>

                        <form method="post" action="/clear-all">
                            <button type="submit" class="btn-danger"
                                    onclick="return confirm('–í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
                                <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ø—Ä–µ–¥–º–µ—Ç—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="content-panel">
                <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
                <div class="card">
                    <h2><i class="fas fa-list-alt"></i> –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</h2>
                    <div class="subjects-list">
                        {% if subjects %}
                            {% for subject in subjects %}
                            <div class="subject-item {% if subject.remaining_hours == 0 %}completed{% endif %}">
                                <div class="subject-info">
                                    <strong>{{ subject.subject_name }}</strong>
                                    <span class="teacher">{{ subject.teacher }}</span>
                                </div>
                                <div class="subject-hours">
                                    <div class="progress-bar">
                                        <div class="progress-fill"
                                             style="width: {{ (subject.remaining_hours / subject.total_hours * 100) if subject.total_hours > 0 else 0 }}%">
                                        </div>
                                    </div>
                                    <span class="hours-badge">{{ subject.remaining_hours }}/{{ subject.total_hours }}—á</span>
                                </div>
                                <form method="post" action="/remove-subject/{{ subject.id }}">
                                    <button type="submit" class="btn-small btn-danger"
                                            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç \"{{ subject.subject_name }}\" —É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è {{ subject.teacher }}?')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-state">
                                <i class="fas fa-inbox"></i><br>
                                –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="card">
                    <div class="schedule-header-row">
                        <h2><i class="fas fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é</h2>
                        <div class="schedule-legend">
                            <div class="legend-item">
                                <div class="legend-color current"></div>
                                <span>–¢–µ–∫—É—â–∏–µ –ø–∞—Ä—ã</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color past"></div>
                                <span>–ü—Ä–æ—à–µ–¥—à–∏–µ –ø–∞—Ä—ã</span>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-container">
                        <div class="schedule">
                            <div class="schedule-corner">
                                <i class="fas fa-clock"></i>
                            </div>

                            {% for day in week_days %}
                            <div class="schedule-day-header {% if day in ['–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'] %}weekend{% endif %}">
                                {{ day }}<br>
                                <small>{{ ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'][loop.index0] }}</small>
                            </div>
                            {% endfor %}

                            {% for time_slot in time_slots %}
                            <div class="schedule-time-slot">
                                {{ time_slot.start }}<br>{{ time_slot.end }}
                                <div class="time-slot-number">{{ loop.index0 + 1 }}</div>
                            </div>

                            {% for day in range(total_days) %}
                            <div class="schedule-cell {% if day >= 5 %}weekend{% endif %}
                                {% if schedule_matrix[day][loop.index0] and schedule_matrix[day][loop.index0].is_past %}past{% endif %}">

                                {% if schedule_matrix[day][loop.index0] %}
                                    {% set lesson = schedule_matrix[day][loop.index0] %}
                                    <div class="lesson-card">
                                        <div class="lesson-content">
                                            <strong>{{ lesson.subject_name }}</strong>
                                            <div class="lesson-teacher">{{ lesson.teacher }}</div>
                                            <div class="lesson-time">{{ time_slot.start }}-{{ time_slot.end }}</div>
                                        </div>
                                        {% if not lesson.is_past %}
                                        <form method="post" action="/remove-lesson">
                                            <input type="hidden" name="day" value="{{ day }}">
                                            <input type="hidden" name="time_slot" value="{{ loop.index0 }}">
                                            <button type="submit" class="lesson-remove-btn"
                                                    title="–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞—Ä—É?')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                        {% else %}
                                        <div class="lesson-past-badge">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="empty-slot">
                                        <i class="fas fa-plus"></i>
                                        <span>–°–≤–æ–±–æ–¥–Ω–æ</span>
                                    </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            {% if loop.index0 == 1 %}
                            <div class="lunch-break">
                                <i class="fas fa-utensils"></i>
                                –û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div class="modal" id="lessonModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä–µ</h3>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateTeacherSelect() {
            const teacherSelect = document.getElementById('filter_teacher');
            if (teacherSelect) {
                const subjects = {{ subjects | tojson }};
                const currentValue = teacherSelect.value;

                teacherSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>';

                const uniqueTeachers = new Set();
                subjects.forEach(subject => {
                    uniqueTeachers.add(subject.teacher);
                });

                uniqueTeachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher;
                    option.textContent = teacher;
                    if (teacher === currentValue) {
                        option.selected = true;
                    }
                    teacherSelect.appendChild(option);
                });
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.getElementById('lessonModal');
        const closeBtn = document.querySelector('.close');

        function showLessonInfo(lesson) {
            document.getElementById('modalContent').innerHTML = `
                <p><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> ${lesson.subject_name}</p>
                <p><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> ${lesson.teacher}</p>
                <p><strong>–î–µ–Ω—å:</strong> ${getDayName(lesson.day)}</p>
                <p><strong>–í—Ä–µ–º—è:</strong> ${getTimeSlotName(lesson.time_slot)}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${lesson.is_past ? '–ü—Ä–æ—à–µ–¥—à–∞—è' : '–ü—Ä–µ–¥—Å—Ç–æ—è—â–∞—è'}</p>
            `;
            modal.style.display = 'block';
        }

        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getDayName(dayIndex) {
            const days = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
            return days[dayIndex] || '';
        }

        function getTimeSlotName(timeSlot) {
            const slots = [
                '9:00-10:30', '10:40-12:10', '12:40-14:10', '14:20-15:50'
            ];
            return slots[timeSlot] || '';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateTeacherSelect();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(updateTeacherSelect, 30000);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–∞—Ä
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('.lesson-remove-btn')) {
                        const day = this.closest('.schedule-cell').dataset.day;
                        const timeSlot = this.closest('.schedule-cell').dataset.timeSlot;
                        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ä–µ
                    }
                });
            });
        });

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.getElementById('teacher').addEventListener('input', function() {
            const input = this.value.toLowerCase();
            const subjects = {{ subjects | tojson }};
            const uniqueTeachers = new Set(subjects.map(s => s.teacher));

            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–ª–∏ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
        });
    </script>
</body>
</html>